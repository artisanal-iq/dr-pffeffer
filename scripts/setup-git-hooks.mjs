#!/usr/bin/env node
import { existsSync, mkdirSync, readFileSync, writeFileSync, chmodSync } from 'node:fs';
import { resolve, dirname } from 'node:path';

const gitDir = resolve(process.cwd(), '.git');
if (!existsSync(gitDir)) {
  console.log('No .git directory detected. Skipping hook installation.');
  process.exit(0);
}

const hookPath = resolve(gitDir, 'hooks', 'pre-commit');
const hookDir = dirname(hookPath);
if (!existsSync(hookDir)) {
  mkdirSync(hookDir, { recursive: true });
}

const hookContents = `#!/bin/sh\n# Auto-generated by scripts/setup-git-hooks.mjs\n\ncommand -v pnpm >/dev/null 2>&1\nif [ $? -ne 0 ]; then\n  echo "pnpm is required to run environment validation."\n  exit 1\nfi\n\npnpm validate-env\n`;

let shouldWrite = true;
if (existsSync(hookPath)) {
  const current = readFileSync(hookPath, 'utf8');
  if (current === hookContents) {
    shouldWrite = false;
  } else if (!current.includes('pnpm validate-env')) {
    console.warn('Existing pre-commit hook detected. Append pnpm validate-env manually if needed.');
    shouldWrite = false;
  }
}

if (shouldWrite) {
  writeFileSync(hookPath, hookContents, 'utf8');
  chmodSync(hookPath, 0o755);
  console.log('Installed pnpm validate-env pre-commit hook.');
}
